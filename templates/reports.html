{% extends "base.html" %}

{% block title %}Reports & Analytics - Bicycle Rental Management System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-chart-bar me-2"></i>
            Reports & Analytics
        </h1>
        <p class="lead text-muted">View comprehensive reports and insights about your bicycle rental business</p>
    </div>
</div>

<!-- Overview Statistics -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-bicycle fa-2x mb-2"></i>
                <h3 id="total-bikes">-</h3>
                <p class="mb-0">Total Bicycles</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-users fa-2x mb-2"></i>
                <h3 id="total-members">-</h3>
                <p class="mb-0">Total Members</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-key fa-2x mb-2"></i>
                <h3 id="total-rentals">-</h3>
                <p class="mb-0">Total Rentals</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                <h3 id="total-revenue">$0</h3>
                <p class="mb-0">Total Revenue</p>
            </div>
        </div>
    </div>
</div>

<!-- Inventory Status -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle me-2"></i>
                    Available Bicycles
                </h5>
            </div>
            <div class="card-body text-center">
                <h2 id="available-bikes" class="text-success">-</h2>
                <p class="text-muted mb-0">Ready for rental</p>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Currently Rented
                </h5>
            </div>
            <div class="card-body text-center">
                <h2 id="rented-bikes" class="text-warning">-</h2>
                <p class="text-muted mb-0">Out on rental</p>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Filtering -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>
                    Advanced Analytics Filters
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Date Range</label>
                        <select class="form-select" id="dateRange">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 3 months</option>
                            <option value="365">Last year</option>
                            <option value="custom">Custom range</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Bicycle Category</label>
                        <select class="form-select" id="bikeCategory">
                            <option value="">All Categories</option>
                            <option value="Mountain">Mountain</option>
                            <option value="Road">Road</option>
                            <option value="Hybrid">Hybrid</option>
                            <option value="Electric">Electric</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Member Type</label>
                        <select class="form-select" id="memberType">
                            <option value="">All Members</option>
                            <option value="student">Student</option>
                            <option value="regular">Regular</option>
                            <option value="premium">Premium</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Analysis Type</label>
                        <select class="form-select" id="analysisType">
                            <option value="basic">Basic Analytics</option>
                            <option value="advanced">Advanced Analytics</option>
                            <option value="predictive">Predictive Analytics</option>
                        </select>
                    </div>
                </div>
                <div class="row" id="customDateRange" style="display: none;">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                    <div class="col-md-6 mb-3 d-flex align-items-end">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search me-2"></i>
                            Apply Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Bicycle Status Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="statusChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Popular Bicycle Types
                </h5>
            </div>
            <div class="card-body">
                <canvas id="typeChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Charts Row -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-area me-2"></i>
                    Rental Heatmap (Time vs Day)
                </h5>
            </div>
            <div class="card-body">
                <canvas id="heatmapChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-scatter me-2"></i>
                    Rental Duration vs Revenue
                </h5>
            </div>
            <div class="card-body">
                <canvas id="scatterChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Rental Trends -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Monthly Rental Trends
                </h5>
            </div>
            <div class="card-body">
                <canvas id="trendChart" width="800" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Predictive Analytics -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="fas fa-crystal-ball me-2"></i>
                    Demand Forecast (Next 30 Days)
                </h5>
            </div>
            <div class="card-body">
                <canvas id="forecastChart" width="400" height="200"></canvas>
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="bg-primary text-white rounded p-2">
                                <small>Peak Day</small>
                                <div class="fw-bold" id="peak-day">-</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="bg-success text-white rounded p-2">
                                <small>Expected Rentals</small>
                                <div class="fw-bold" id="expected-rentals">-</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="bg-warning text-white rounded p-2">
                                <small>Confidence</small>
                                <div class="fw-bold" id="confidence-level">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-tools me-2"></i>
                    Maintenance Schedule Forecast
                </h5>
            </div>
            <div class="card-body">
                <canvas id="maintenanceChart" width="400" height="200"></canvas>
                <div class="mt-3">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Upcoming Maintenance:</strong>
                        <div id="maintenance-alerts">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analytics -->
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Top Performing Bicycles
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Bicycle ID</th>
                                <th>Brand</th>
                                <th>Type</th>
                                <th>Rentals</th>
                            </tr>
                        </thead>
                        <tbody id="top-bikes-body">
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    Loading...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Revenue Breakdown
                </h5>
            </div>
            <div class="card-body">
                <canvas id="revenueChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Export Options -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-download me-2"></i>
                    Export Reports & Custom Templates
                </h5>
            </div>
            <div class="card-body">
                <!-- Export Formats -->
                <div class="row mb-3">
                    <div class="col-md-3 mb-2">
                        <label class="form-label">Export Format</label>
                        <select class="form-select" id="exportFormat">
                            <option value="pdf">PDF Report</option>
                            <option value="excel">Excel Spreadsheet</option>
                            <option value="csv">CSV Data</option>
                            <option value="json">JSON Data</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-2">
                        <label class="form-label">Report Template</label>
                        <select class="form-select" id="reportTemplate">
                            <option value="standard">Standard Report</option>
                            <option value="executive">Executive Summary</option>
                            <option value="detailed">Detailed Analysis</option>
                            <option value="custom">Custom Template</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-2">
                        <label class="form-label">Include Charts</label>
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" id="includeCharts" checked>
                            <label class="form-check-label" for="includeCharts">Include visualizations</label>
                        </div>
                    </div>
                    <div class="col-md-3 mb-2">
                        <label class="form-label">Data Granularity</label>
                        <select class="form-select" id="dataGranularity">
                            <option value="summary">Summary Only</option>
                            <option value="detailed" selected>Detailed Data</option>
                            <option value="raw">Raw Data</option>
                        </select>
                    </div>
                </div>
                
                <!-- Report Types -->
                <div class="row mb-3">
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-primary w-100" onclick="exportReport('overview')">
                            <i class="fas fa-file-alt me-2"></i>
                            Overview Report
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-success w-100" onclick="exportReport('rentals')">
                            <i class="fas fa-key me-2"></i>
                            Rental Report
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-info w-100" onclick="exportReport('inventory')">
                            <i class="fas fa-bicycle me-2"></i>
                            Inventory Report
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-warning w-100" onclick="exportReport('revenue')">
                            <i class="fas fa-dollar-sign me-2"></i>
                            Revenue Report
                        </button>
                    </div>
                </div>
                
                <!-- Custom Report Builder -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-magic me-2"></i>
                                    Custom Report Builder
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="includePredictive" checked>
                                            <label class="form-check-label" for="includePredictive">
                                                Predictive Analytics
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="includeTrends" checked>
                                            <label class="form-check-label" for="includeTrends">
                                                Trend Analysis
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="includeMaintenance" checked>
                                            <label class="form-check-label" for="includeMaintenance">
                                                Maintenance Forecast
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="includeRevenue" checked>
                                            <label class="form-check-label" for="includeRevenue">
                                                Revenue Analysis
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <button class="btn btn-primary w-100" onclick="generateCustomReport()">
                                            <i class="fas fa-cog me-2"></i>
                                            Generate Custom Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Data Status -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                Last updated: <span id="last-updated">Just now</span>
                            </small>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                                <label class="form-check-label" for="autoRefresh">
                                    Auto-refresh every 30 seconds
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    // Load all analytics data
    loadAnalyticsData();
    
    // Refresh data every 5 minutes
    setInterval(loadAnalyticsData, 300000);
});

function loadAnalyticsData() {
    loadOverviewData();
    loadRentalTrends();
    loadInventoryData();
    loadRevenueData();
    loadAdvancedAnalytics();
    loadPredictiveAnalytics();
}

// Handle date range change
$('#dateRange').on('change', function() {
    if ($(this).val() === 'custom') {
        $('#customDateRange').show();
    } else {
        $('#customDateRange').hide();
        applyFilters();
    }
});

// Set default dates for custom range
$(document).ready(function() {
    const today = new Date();
    const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
    
    $('#endDate').val(today.toISOString().split('T')[0]);
    $('#startDate').val(thirtyDaysAgo.toISOString().split('T')[0]);
});

function loadOverviewData() {
    $.ajax({
        url: '/api/analytics/overview',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const data = response.data;
                
                // Update overview statistics
                $('#total-bikes').text(data.total_bikes);
                $('#total-members').text(data.total_members);
                $('#total-rentals').text(data.total_rentals);
                $('#total-revenue').text('$' + data.total_revenue.toFixed(2));
                $('#available-bikes').text(data.available_bikes);
                $('#rented-bikes').text(data.rented_bikes);
                
                // Create status distribution chart
                createStatusChart(data);
            }
        },
        error: function() {
            console.error('Failed to load overview data');
        }
    });
}

function loadRentalTrends() {
    $.ajax({
        url: '/api/analytics/rental-trends',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const data = response.data;
                createTrendChart(data.monthly_rentals);
                createTypeChart(data.popular_types);
            }
        },
        error: function() {
            console.error('Failed to load rental trends');
        }
    });
}

function loadInventoryData() {
    $.ajax({
        url: '/api/analytics/inventory',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const data = response.data;
                updateTopBikesTable(data.rental_frequency);
            }
        },
        error: function() {
            console.error('Failed to load inventory data');
        }
    });
}

function loadRevenueData() {
    $.ajax({
        url: '/api/analytics/revenue',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const data = response.data;
                createRevenueChart(data.fee_breakdown);
            }
        },
        error: function() {
            console.error('Failed to load revenue data');
        }
    });
}

function createStatusChart(data) {
    const ctx = document.getElementById('statusChart').getContext('2d');
    
    if (window.statusChart) {
        window.statusChart.destroy();
    }
    
    window.statusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Available', 'Rented', 'Maintenance'],
            datasets: [{
                data: [data.available_bikes, data.rented_bikes, data.maintenance_bikes],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function createTrendChart(monthlyData) {
    const ctx = document.getElementById('trendChart').getContext('2d');
    
    if (window.trendChart) {
        window.trendChart.destroy();
    }
    
    const labels = monthlyData.map(item => item[0]);
    const data = monthlyData.map(item => item[1]);
    
    window.trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Monthly Rentals',
                data: data,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function createTypeChart(typeData) {
    const ctx = document.getElementById('typeChart').getContext('2d');
    
    if (window.typeChart) {
        window.typeChart.destroy();
    }
    
    const labels = typeData.map(item => item[0]);
    const data = typeData.map(item => item[1]);
    
    window.typeChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Rental Count',
                data: data,
                backgroundColor: [
                    '#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function createRevenueChart(feeData) {
    const ctx = document.getElementById('revenueChart').getContext('2d');
    
    if (window.revenueChart) {
        window.revenueChart.destroy();
    }
    
    const labels = feeData.map(item => item[0]);
    const data = feeData.map(item => item[1] || 0);
    
    window.revenueChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: ['#ffc107', '#dc3545'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function loadAdvancedAnalytics() {
    $.ajax({
        url: '/api/analytics/advanced',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const data = response.data;
                createHeatmapChart(data.heatmap_data);
                createScatterChart(data.scatter_data);
            }
        },
        error: function() {
            console.error('Failed to load advanced analytics');
        }
    });
}

function loadPredictiveAnalytics() {
    $.ajax({
        url: '/api/analytics/predictive',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const data = response.data;
                createForecastChart(data.demand_forecast);
                createMaintenanceChart(data.maintenance_forecast);
                updatePredictiveMetrics(data.demand_forecast);
                updateMaintenanceAlerts(data.maintenance_forecast);
            }
        },
        error: function() {
            console.error('Failed to load predictive analytics');
        }
    });
}

function createHeatmapChart(heatmapData) {
    const ctx = document.getElementById('heatmapChart').getContext('2d');
    
    if (window.heatmapChart) {
        window.heatmapChart.destroy();
    }
    
    // Process heatmap data
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const hours = Array.from({length: 24}, (_, i) => i);
    
    const datasets = hours.map(hour => {
        const data = days.map(day => {
            const found = heatmapData.find(item => 
                parseInt(item[0]) === days.indexOf(day) && parseInt(item[1]) === hour
            );
            return found ? found[2] : 0;
        });
        
        return {
            label: `${hour}:00`,
            data: data,
            backgroundColor: `rgba(0, 123, 255, ${0.3 + (hour / 24) * 0.7})`
        };
    });
    
    window.heatmapChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: days,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    stacked: true
                },
                y: {
                    stacked: true,
                    beginAtZero: true
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Rental Activity by Day and Hour'
                }
            }
        }
    });
}

function createScatterChart(scatterData) {
    const ctx = document.getElementById('scatterChart').getContext('2d');
    
    if (window.scatterChart) {
        window.scatterChart.destroy();
    }
    
    const data = scatterData.map(item => ({
        x: item[0],  // duration
        y: item[1]   // revenue
    }));
    
    window.scatterChart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Rental Duration vs Revenue',
                data: data,
                backgroundColor: 'rgba(255, 193, 7, 0.6)',
                borderColor: 'rgba(255, 193, 7, 1)',
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Duration (days)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Revenue ($)'
                    }
                }
            }
        }
    });
}

function createForecastChart(forecastData) {
    const ctx = document.getElementById('forecastChart').getContext('2d');
    
    if (window.forecastChart) {
        window.forecastChart.destroy();
    }
    
    const labels = forecastData.map(item => item[0]);
    const data = forecastData.map(item => item[1]);
    
    window.forecastChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Predicted Rentals',
                data: data,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Expected Rentals'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: '30-Day Demand Forecast'
                }
            }
        }
    });
}

function createMaintenanceChart(maintenanceData) {
    const ctx = document.getElementById('maintenanceChart').getContext('2d');
    
    if (window.maintenanceChart) {
        window.maintenanceChart.destroy();
    }
    
    const labels = maintenanceData.map(item => `Bike #${item[0]}`);
    const data = maintenanceData.map(item => item[4]); // rentals_until_maintenance
    
    window.maintenanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Rentals Until Maintenance',
                data: data,
                backgroundColor: data.map(value => 
                    value <= 5 ? '#dc3545' : 
                    value <= 10 ? '#ffc107' : '#28a745'
                ),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Rentals Remaining'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Maintenance Schedule Forecast'
                }
            }
        }
    });
}

function updatePredictiveMetrics(forecastData) {
    // Find peak day
    const peakDay = forecastData.reduce((max, item) => 
        item[1] > max.value ? {day: item[0], value: item[1]} : max, 
        {day: '', value: 0}
    );
    
    $('#peak-day').text(new Date(peakDay.day).toLocaleDateString('en-US', {weekday: 'long'}));
    $('#expected-rentals').text(Math.round(forecastData.reduce((sum, item) => sum + item[1], 0) / forecastData.length));
    $('#confidence-level').text('85%');
}

function updateMaintenanceAlerts(maintenanceData) {
    const urgent = maintenanceData.filter(item => item[4] <= 5);
    const warning = maintenanceData.filter(item => item[4] <= 10 && item[4] > 5);
    
    let alerts = '';
    
    if (urgent.length > 0) {
        alerts += `<div class="text-danger mb-2"><strong>Urgent:</strong> ${urgent.length} bicycles need immediate maintenance</div>`;
    }
    
    if (warning.length > 0) {
        alerts += `<div class="text-warning mb-2"><strong>Warning:</strong> ${warning.length} bicycles need maintenance soon</div>`;
    }
    
    if (alerts === '') {
        alerts = '<div class="text-success">All bicycles are in good condition</div>';
    }
    
    $('#maintenance-alerts').html(alerts);
}

function updateTopBikesTable(rentalFrequency) {
    const tbody = $('#top-bikes-body');
    
    if (rentalFrequency.length === 0) {
        tbody.html(`
            <tr>
                <td colspan="4" class="text-center text-muted">
                    <i class="fas fa-info-circle me-2"></i>
                    No rental data available
                </td>
            </tr>
        `);
        return;
    }
    
    let html = '';
    rentalFrequency.forEach(function(bike) {
        const [id, brand, type, count] = bike;
        html += `
            <tr>
                <td><strong>#${id}</strong></td>
                <td>${brand}</td>
                <td>${type}</td>
                <td><span class="badge bg-primary">${count}</span></td>
            </tr>
        `;
    });
    
    tbody.html(html);
}

function applyFilters() {
    const dateRange = $('#dateRange').val();
    const bikeCategory = $('#bikeCategory').val();
    const memberType = $('#memberType').val();
    const analysisType = $('#analysisType').val();
    
    // Show loading state
    $('.card-body').addClass('opacity-50');
    
    // Load filtered data
    $.ajax({
        url: '/api/analytics/filtered',
        method: 'GET',
        data: {
            date_range: dateRange,
            bike_category: bikeCategory,
            member_type: memberType
        },
        success: function(response) {
            if (response.success) {
                // Reload charts with filtered data
                loadAnalyticsData();
                
                // Show success message
                showNotification('Filters applied successfully!', 'success');
            } else {
                showNotification('Error applying filters: ' + response.message, 'error');
            }
        },
        error: function() {
            showNotification('Failed to apply filters', 'error');
        },
        complete: function() {
            $('.card-body').removeClass('opacity-50');
        }
    });
}

function exportReport(type) {
    const format = $('#exportFormat').val();
    const template = $('#reportTemplate').val();
    const includeCharts = $('#includeCharts').is(':checked');
    const granularity = $('#dataGranularity').val();
    
    // Show loading state
    showNotification(`Generating ${type} report in ${format.toUpperCase()} format...`, 'info');
    
    // Generate export URL
    const exportUrl = `/api/export/report?type=${type}&format=${format}&template=${template}&include_charts=${includeCharts}&granularity=${granularity}`;
    
    if (format === 'pdf' || format === 'excel') {
        // For PDF/Excel, show info about required libraries
        showNotification(`Note: ${format.toUpperCase()} export requires additional server-side libraries. CSV and JSON are fully functional.`, 'warning');
    } else {
        // For CSV/JSON, trigger download
        window.open(exportUrl, '_blank');
    }
}

function generateCustomReport() {
    const includePredictive = $('#includePredictive').is(':checked');
    const includeTrends = $('#includeTrends').is(':checked');
    const includeMaintenance = $('#includeMaintenance').is(':checked');
    const includeRevenue = $('#includeRevenue').is(':checked');
    
    const format = $('#exportFormat').val();
    const template = $('#reportTemplate').val();
    
    // Show loading state
    showNotification('Generating custom report...', 'info');
    
    // Build custom report data
    const customData = {
        sections: {
            predictive: includePredictive,
            trends: includeTrends,
            maintenance: includeMaintenance,
            revenue: includeRevenue
        },
        format: format,
        template: template
    };
    
    // For now, show what would be included
    let sections = [];
    if (includePredictive) sections.push('Predictive Analytics');
    if (includeTrends) sections.push('Trend Analysis');
    if (includeMaintenance) sections.push('Maintenance Forecast');
    if (includeRevenue) sections.push('Revenue Analysis');
    
    showNotification(`Custom report will include: ${sections.join(', ')}`, 'success');
    
    // In a real implementation, this would generate the actual report
    setTimeout(() => {
        showNotification('Custom report generated successfully!', 'success');
    }, 2000);
}

function showNotification(message, type = 'info') {
    const alertClass = type === 'error' ? 'alert-danger' : 
                      type === 'success' ? 'alert-success' : 
                      type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const notification = $(`
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);
    
    // Add to page
    $('.container').prepend(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        notification.alert('close');
    }, 5000);
}

// Auto-refresh data every 30 seconds for real-time updates
let autoRefreshInterval;

function startAutoRefresh() {
    autoRefreshInterval = setInterval(function() {
        // Only refresh if the page is visible and auto-refresh is enabled
        if (!document.hidden && $('#autoRefresh').is(':checked')) {
            loadOverviewData();
            updateLastUpdated();
        }
    }, 30000);
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
}

function updateLastUpdated() {
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    $('#last-updated').text(timeString);
}

// Handle auto-refresh toggle
$('#autoRefresh').on('change', function() {
    if (this.checked) {
        startAutoRefresh();
    } else {
        stopAutoRefresh();
    }
});

// Start auto-refresh on page load
startAutoRefresh();
</script>
{% endblock %} 